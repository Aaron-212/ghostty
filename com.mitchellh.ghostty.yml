app-id: com.mitchellh.ghostty
runtime: org.gnome.Platform
runtime-version: '43'
sdk: org.gnome.Sdk
platform-extensions:
  - org.freedesktop.Platform.GL.default
default-branch: tip
command: ghostty
build-options:
  append-path: /app/tmp/zig
cleanup:
  - /app/tmp/zig
finish-args:
  # 3D rendering
  - --device=dri
  # Windowing
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  # Files (we are a terminal so we need all of them)
  - --filesystem=host
  # So we can escape the sandbox
  - --talk-name=org.freedesktop.Flatpak
modules:
  # Note: this should be kept in sync with our flake.nix. Over time this
  # should stabilize to being a release version and not a nightly.
  - name: zig
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/zig
      - cp -r ./* /app/tmp/zig
    sources:
      - type: archive
        url: https://ziglang.org/builds/zig-linux-x86_64-0.11.0-dev.1650+5e7b09ce9.tar.xz
        sha256: 8b77a475d3d124f0d4a4c4d4e2756f4a5317838272c08341325f196e8d539747
        only-arches:
          - x86_64
      - type: archive
        url: https://ziglang.org/builds/zig-linux-aarch64-0.11.0-dev.1650+5e7b09ce9.tar.xz
        sha256: 104c2370c6eba25164ede3fefaf133ed650cca951f2e473bd533cfb0660c4e23
        only-arches:
          - aarch64

  # We use this to get a proper PTY on our host spawn. We should eventually
  # replace this with using dbus directly.
  - name: host-spawn
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin
      - mv ./host-spawn-* /app/bin/host-spawn
      - chmod +x /app/bin/host-spawn
    sources:
      - type: file
        url: https://github.com/1player/host-spawn/releases/download/1.4.1/host-spawn-x86_64
        sha256: d81bb6125ec73a9a2e26266c48787367fbcb665d67c2e7fb42217f0981106cf7
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/1player/host-spawn/releases/download/1.4.1/host-spawn-aarch64
        sha256: 29bff846d72e37093b3fdf7859bae16addd64acc98087f8c059548df3c2273c4
        only-arches:
          - aarch64

  - name: ghostty
    buildsystem: simple
    build-commands:
      - MACH_SDK_PATH="$(pwd)/vendor/mach-sdk" zig build -Doptimize=ReleaseFast -Dcpu=baseline -Dapp-runtime=gtk --prefix /app
    sources:
      - type: dir
        path: .
        skip:
          - .flatpak-builder
          - zig-cache
          - zig-out
